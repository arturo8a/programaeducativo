<html xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8" />

<link rel="stylesheet" href="../static/css/style.css" th:href="@{/css/style.css}">
<link rel="stylesheet" href="../static/css/nuevo_disenio.css" th:href="@{/css/nuevo_disenio.css}">
<link href="../static/css/gijgo.min.css" rel="stylesheet" th:href="@{/css/gijgo.min.css}" >
<link href="../static/css/font-awesome.min.css" rel="stylesheet" th:href="@{/css/font-awesome.min.css}" >
<script type="text/javascript" th:src="@{/js/gijgo.min.js}" ></script>
<script type="text/javascript" th:src="@{/js/messages.es-es.js}"></script>
<script type="text/javascript" th:src="@{/js/datetime-moment-order.js}"></script>
<script type="text/javascript" th:src="@{/js/moment.js}"></script>

<div id="containerListaRegistros" class="pl-3 pr-3">
	<div class="div_filtro">
		<div class="row p-0 m-0">			
			<div class="col-xs-4 col-sm-4">
				<select class="form-control" id="anioce" name="anioce">
					<option value="Todos">Año</option>
					<option th:each="dato:${anios}" th:value="${dato}" th:utext="${dato}"/>       				
				</select>
			</div>
			<div class="col-xs-4 col-sm-4">
				<select class="form-control" id="nivelparticipacionce" name="nivelparticipacionce">
					<option value="Todos">Nivel de participación</option>
					<option th:each="len:${listanivelparticipacion}" th:value="${len.id}" th:utext="${len.descripcion}"/>       				
				</select>
			</div>
			<div class="col-xs-4 col-sm-4">
				<select class="form-control" id="categoriace" name="categoriace">
					<option value="Todos">Categoría</option>
					<option th:each="len:${listacategoriaevaluacion}" th:value="${len.id}" th:utext="${len.descripcion}"/>
				</select>
			</div>
			<div class="col-xs-12 col-sm-4 pt-1">
				<select class="form-control" id="estadoce" name="estadoce">
					<option value="Todos">Estado</option>	
					<option th:each="len:${listaestadoevaluacion}" th:value="${len.id}" th:utext="${len.descripcion}"/>       				
				</select>
			</div>
			<div class="col-xs-12 col-sm-4 pt-1">
				&nbsp;
			</div>
			<div class="col-xs-12 col-sm-4 pt-1 pb-2">
				<input type="button" value="Crear evaluación" id="btncrearevaluacion" name="btncrearevaluacion" class="btn btn-success" />
				<input type="button" name="btnbuscarce" id="btnbuscarce" class="btn btn-primary" value="Buscar"/>
				<input type="button" name="btnlimpiarce" id="btnlimpiarce" class="btn btn-danger" value="Limpiar" style="margin-left:10px"/>
			</div>
		</div>
	</div>
	<br>
	<div class="div_filtro">
		<div class="p-0 m-0">
			<label class="p-2 m-0">CONSULTA DE EVALUACIONES</label>
			<div class="row pt-2 pb-4 m-0">
				<div class="col-xs-12 col-sm-12">
					<table id="table_lista_evaluacion"  class="table table-striped display nowrap" style="width:100%">
						<thead class="cabecera_tabla">
					        <tr>
					        	<th>Nº</th>
								<th>Año</th>
					            <th>Nivel de participación</th>
					            <th>Categoría</th>
					            <th>Estado</th>
					            <th>Ficha</th>
					            <th>Editar</th>
					            <th>Eliminar</th>
					        </tr>   
					    </thead>
					</table>
				</div>
				<br><br>
			</div>
		</div>
	</div>
</div>
		

<div class="modal fade" tabindex="-1" role="dialog" id="modalagregarEvaluacion" aria-labelledby="myLargeModalLabel" >
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content" style="overflow-y: scroll; height:750px">
      <div class="modal-header">
        <strong class="pt-1">CREAR EVALUACIÓN</strong>
      </div>
      <div class="modal-body" id="contenidocrearevaluacion">      	
      </div>
    </div>
  </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modaleditarEvaluacion" aria-labelledby="myLargeModalLabel" >
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content" style="overflow-y: scroll; height:750px">
      <div class="modal-header">
        <strong class="pt-1">EDITAR EVALUACIÓN</strong>
      </div>
      <div class="modal-body" id="contenidoeditarevaluacion">      	
      </div>
    </div>
  </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id="modalexitocrearevaluacion">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <img th:src="@{./images/imagen_exito5.png}"/>&nbsp;&nbsp; <strong class="pt-1">Registro exitoso</strong>
	      </div>
	      <div class="modal-body" id="textoexitocrearevaluacion">
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-primary rounded-0" id="btncerrarmensajeexitocrearevaluacion" name="btncerrarmensajeexitocrearevaluacion">Aceptar</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	
	<div class="modal" tabindex="-1" role="dialog" id="modalerrorcrearevaluacion">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <img th:src="@{./images/imagen_informacion11.png}"/>&nbsp;&nbsp; <strong class="pt-1">Error</strong>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>	          
	        </button>
	      </div>
	      <div class="modal-body" id="textoerrorcrearevaluacion">
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-danger rounded-0" id="btncerrarmensajeerrorcrearevaluacion" name="btncerrarmensajeerrorcrearevaluacion">Cerrar</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<div class="modal" tabindex="-1" role="dialog" id="modalinformacioncrearevaluacion">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <img th:src="@{./images/imagen_informacion11.png}" />&nbsp;&nbsp; <label class="pt-1" style="padding-right:380px">Alerta</label>
	        <!-- button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button-->
	      </div>
	      <div class="modal-body" id="textoinformacioncrearevaluacion">
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-danger rounded-0" id="btncerrarmensajeinformacioncrearevaluacion" name="btncerrarmensajeinformacioncrearevaluacion">Cerrar</button>
	      </div>
	    </div>
	  </div>
	</div>

</html>
<script type="text/javascript">
		
		var objarray="";
		var hhmmss="" ;
		var arrayfecha="" ;
		var fecha=""; 
		var table_lista_evaluacion, celdaseleccionada,id;
		
		$(document).ready(function(){
			
			listar();
			
			$("#btnlimpiarce").click(function(){
				
				$("#anioce").val("Todos");
				$("#nivelparticipacionce").val("Todos");
				$("#categoriace").val("Todos");
				$("#estadoce").val("Todos");
				setTimeout(() => {        		  
					table_lista_evaluacion.draw();
		      	}, 100);
			});
			
			$("#btncrearevaluacion").click(function(){
				$.ajax({
					url: url_base + "pedesa/formcrearevaluacion",
					success: function(respuesta) {
						$("#modalimagencargando").modal('hide');
						$("#contenidocrearevaluacion").html(respuesta);		
						$('#modalagregarEvaluacion').modal({
							show : true,
							backdrop : 'static',
							keyboard:false
						});
					},
					error: function() {
				        console.log("No se ha podido obtener la información");
				    }
				});
			});
			
			$("#btnbuscarce").click(function(){	
				
					
			});			
		});
		
		var listar = function (){
				$("#table_lista_evaluacion").dataTable().fnDestroy();
				table_lista_evaluacion = $('#table_lista_evaluacion').DataTable({
					dom: 'Bfrtip',
		            "scrollX": true,
		            "searching": true,
		            lengthMenu: [
		                [ 10, 15, 25, -1 ],
		                [ '10 filas', '15 filas', '25 filas', 'Mostrar todas' ]
		            ],
		            "processing":true,
		            language: {
		                buttons: {
		                  pageLength: 'Mostrar'
		                },
		                "decimal": "",
		                "emptyTable": "No hay información",
		                "info": "Mostrando _START_ a _END_ de _TOTAL_ Entradas",
		                "infoEmpty": "Mostrando 0 a 0 de 0 Entradas",
		                "infoFiltered": "(Filtrado de _MAX_ total entradas)",
		                "infoPostFix": "",
		                "thousands": ",",
		                "lengthMenu": "Mostrar _MENU_ Entradas",
		                "loadingRecords": "Cargando Registros...",
		                "processing": "Procesando...",
		                "search": "Buscar:",
		                "zeroRecords": "No existen registros",//No existen registros
		                "paginate": {
		                    "first": "Primero",
		                    "last": "Ultimo",
		                    "next": "Siguiente",
		                    "previous": "Anterior"
		                }
		            },
		            'ajax' : {
		                "url" : url_base + 'pedesa/listaevaluaciones',
		                "type" : "GET",
		                "dataSrc" : ""
		            },
		            'columns' : [
		            	{ 
		            		"data": null, "render": function (data, type, full, meta) { return meta.row + 1; }
		            	},
						{ 'data' : 'anio'},
		            	{ 'data' : 'nivelparticipacion' },
		                { 'data' : 'categoriaevaluacion' },
		                { 'data' : 'estado' },
		                { 'defaultContent' : '<img src="./images/svg/file-pdf-regular.svg" class="ver" style="width:20px; cursor:pointer"/>' },
				        { 'defaultContent' : '<img src="./images/svg/edit-regular.svg" class="editar" style="width:20px; cursor:pointer " />'},
				        { 'defaultContent' : '<img src="./images/svg/eliminar-alt-regular.svg" class="eliminar" style="width:20px; cursor:pointer " />'}
		            ],
		            buttons: []
		        });
				obtener_data_verPdf("#table_lista_evaluacion tbody",table_lista_evaluacion);
				obtener_data_editar("#table_lista_evaluacion tbody",table_lista_evaluacion);
				obtener_data_eliminar("#table_lista_evaluacion tbody",table_lista_evaluacion);
		}
		
		var obtener_data_verPdf = function(tbody,table){
			$(tbody).on("click","img.ver",function(){
				celdaseleccionada = table.row($(this).parents("tr")).index();
				var data = table.row($(this).parents("tr")).data();
				id = data.id;
				verPdf(id);
			});
		};		
		
		var obtener_data_editar = function(tbody,table){
			$(tbody).on("click","img.editar",function(){
				celdaseleccionada = table.row($(this).parents("tr")).index();
				var data = table.row($(this).parents("tr")).data();
				id = data.id;
				editarevaluacion(id);
			});
		};
		
		var obtener_data_eliminar = function(tbody,table){
			$(tbody).on("click","img.eliminar",function(){
				celdaseleccionada = table.row($(this).parents("tr")).index();
				var data = table.row($(this).parents("tr")).data();
				id = data.id;
				eliminarevaluacion(id);
			});
		};
		
		function verPdf(id){
	    	
	    	$.ajax({
				type : "GET",
			    contentType : "application/json",
			    url : url_base + "pedesa/descargarevaluacionpdf/"+id,
				success: function(respuesta) {
					window.open(respuesta, '_blank');
				},
				error: function() {
					$("#modalimagencargando").modal('hide');
					$("#textoerror").html("Excepcion al descargar PDF");
					$('#modalerror').modal({
						show : true,
						backdrop : 'static',
						keyboard:false
					});
			    }
			});    	
	    }
		
		
		function editarevaluacion(id){
			
			$("#modalimagencargando").modal({
				show : true,
				backdrop : 'static',
				keyboard:false
			});
			
			$.ajax({
				type : "GET",
			    url : url_base + "pedesa/editarviewevaluacionid/"+ id,
				success: function(respuesta) {
					$("#contenidoeditarevaluacion").html(respuesta);
					$("#modaleditarEvaluacion").modal();
				},
				error: function() {
					$("#modalimagencargando").modal('hide');
					$("#textoerror").html("Excepcion al cargar vista editar");
					$('#modalerror').modal({
						show : true,
						backdrop : 'static',
						keyboard:false
					});
			    }
			});		
		}
		
		
		function eliminarevaluacion(id){
			var r = confirm("¿ Está seguro de eliminar la evaluación ?");
			if (r == true) {
				$.ajax({
					type : "GET",
				    url : url_base + "pedesa/eliminarevaluacionid/"+ id,
					success: function(respuesta) {
						if(respuesta==1){
							table_lista_evaluacion.row(celdaseleccionada).remove().draw(false);
						}
						else{
							$("#modalimagencargando").modal('hide');
							$("#textoerrorcrearevaluacion").html("No se pudo Eliminar Evaluación");
							$('#modalerrorcrearevaluacion').modal({
								show : true,
								backdrop : 'static',
								keyboard:false
							});
						}
					},
					error: function() {
						$("#modalimagencargando").modal('hide');
						$("#textoerrorcrearevaluacion").html("Excepcion Eliminar Evaluación");
						$('#modalerrorcrearevaluacion').modal({
							show : true,
							backdrop : 'static',
							keyboard:false
						});
				    }
				});			
			}
		}
		
		/*$('#table_lista_evaluacion').DataTable().on("draw", function(){
		});*/
		
		$.fn.dataTable.ext.search.push(
    	    function( settings, data, dataIndex ) {
    	    	
    	    	console.log("settings.nTable.id :" + settings.nTable.id);
    	    	if ( settings.nTable.id !== 'table_lista_evaluacion' ) {
    	            return true;
    	          }
    	    	
    	    	/*var nombre = $("#nomie").val();
    	    	var departamento = $("#departamento option:selected").text();
    	    	var provincia = $("#provincia option:selected").text();
    	    	var distrito = $("#distrito option:selected").text();
    	    	var estado = $("#estado option:selected").val();
    	    	
    	    	if(!filtraUbigeo(departamento,data[2]))
    	    		return false;
    	    	if(!filtraUbigeo(provincia,data[3]))
    	    		return false;
    	    	if(!filtraUbigeo(distrito,data[4]))
    	    		return false;	    	
    	    	if(!filtraNombre(nombre,data[5]))
    	    		return false;
    	    	if(!filtraFecha(fecha_desde,fecha_hasta,data[7]))
    	    		return false;
    	    	if(!filtraConcurso(estado,data[8]))
    	    		return false;*/
   	    		return true;
    	    }
    	);
	    
</script>

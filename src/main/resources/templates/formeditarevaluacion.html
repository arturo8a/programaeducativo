<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>ProgramaEducativo</title>
    <script type="text/javascript">
		window.history.forward();
	</script>

    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="../static/css/style.css" th:href="@{/css/style.css}">
	
	<script type="text/javascript" th:src="@{/js/jquery-3.3.1.js}" ></script>
    <script type="text/javascript" th:src="@{/js/bootstrapv4.js}" ></script>
    <script type="text/javascript" th:src="@{/js/jquery-ui.js}" ></script>
	
	<script type="text/javascript" th:src="@{/js/jquery-ui.js}" ></script>
	
	<link rel="stylesheet" href="../static/css/style.css" th:href="@{/css/style.css}">   
</head>
<body>
		<input type="hidden" id="id_rubrica" name="id_rubrica" th:value="${id_rubrica}" />
		<input type="hidden" id="id_questionario" name="id_questionario" th:value="${id_questionario}" />
		<input type="hidden" id="id_evaluacion" name="id_evaluacion" th:value="${id_evaluacion}" />
		<input type="hidden" id="id_pregunta_respuesta" name="id_pregunta_respuesta" th:value="${id_pregunta_respuesta}" />
		<div class="row">
			<div class="col-xs-12 col-sm-4 text-left">
				<label for="categoriatrabajo">Año</label>
				<input type="text" class="form-control" id="anioce_edit" name="anioce_edit" th:value="*{anio}" disabled />				
			</div>
			<div class="col-xs-12 col-sm-4 text-left">
				<label for="modalidadpostulaciontrabajo">Categoría</label>
				<select class="form-control" id="categoriace_edit" name="categoriace_edit"  th:field="*{evaluacion.categoriaevaluacion.id}">
					<option value="">Todos</option>
					<option th:each="len:${listacategoriaevaluacion}" th:value="${len.id}" th:utext="${len.descripcion}"/>
				</select>
			</div>
			<div class="col-xs-12 col-sm-4 text-left">
				<label for="titulotrabajo">Nivel de participación</label>
				<select class="form-control" id="nivelparticipacionce_edit" name="nivelparticipacionce_edit"  th:field="*{evaluacion.nivelparticipacion.id}">
					<option value="">Todos</option>
					<option th:each="len:${listanivelparticipacion}" th:value="${len.id}" th:utext="${len.descripcion}"/>       				
				</select>
			</div>
		</div>
		<br>
		<div th:each="objeto : ${listarubrica}">
					<div>
						<div class="row" style="background-color:#9E9E9E;padding:10px">
							<div class="col-xs-12 col-sm-6">
								&nbsp;
							</div>		
							<div class="col-xs-12 col-sm-6 text-right">
								<table style="width:100%">
									<tr>
										<td>
											<strong style="margin:5px">Rubrica</strong>
										</td>
										<td>
											<input type="text" th:id="'rubrica' + ${objeto.id}" th:value="${objeto.rubrica}" class="form-control">
										</td>
									</tr>
								</table>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-3">
								<label>Criterio</label>
								<input type="text" th:id="'criterio'+ ${objeto.id} + '1'" th:value="${objeto.criterio1}" class="form-control" />
								<br>
								<textarea rows="3" style="width:100%" th:id="'descripcion' + ${objeto.id} + '1'" th:text="${objeto.descripcion1}" class="form-control">
								</textarea> 
								<br>
								<table>
									<tr>
										<td>
											<label>Puntaje</label>
										</td>
										<td>
											<select th:id="'puntaje' + ${objeto.id} + '1'" class="form-control" >
												<option value="0">Seleccione</option>
												<option th:each="len:${listapuntaje}" th:value="${len}" th:utext="${len}" th:selected="${len == objeto.puntaje1}"/>
											</select>
										</td>
									</tr>
								</table>				
							</div>
							<div class="col-xs-12 col-sm-6 col-md-3">
								<label>Criterio</label>
								<input type="text" th:id="'criterio'+ ${objeto.id} + '2'" th:value="${objeto.criterio2}"  class="form-control" />
								<br>
								<textarea rows="3" style="width:100%" th:id="'descripcion' + ${objeto.id} + '2'" th:text="${objeto.descripcion2}" class="form-control">
								</textarea>
								<br>
								<table>
									<tr>
										<td>
											<label>Puntaje</label>
										</td>
										<td>
											<select th:id="'puntaje' + ${objeto.id} + '2'" class="form-control" >
												<option value="0">Seleccione</option>
												<option th:each="len:${listapuntaje}" th:value="${len}" th:utext="${len}" th:selected="${len == objeto.puntaje2}"/>
											</select>
										</td>
									</tr>
								</table>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-3">
								<label>Criterio</label>
								<input type="text" th:id="'criterio'+ ${objeto.id} + '3'" th:value="${objeto.criterio3}" class="form-control" />
								<br>
								<textarea rows="3" style="width:100%" th:id="'descripcion' + ${objeto.id} + '3'" th:text="${objeto.descripcion3}" class="form-control">
								</textarea>
								<br>
								<table>
									<tr>
										<td>
											<label>Puntaje</label>
										</td>
										<td>
											<select th:id="'puntaje' + ${objeto.id} + '3'" class="form-control" >
												<option value="0">Seleccione</option>
												<option th:each="len:${listapuntaje}" th:value="${len}" th:utext="${len}" th:selected="${len == objeto.puntaje3}"/>
											</select>
										</td>
									</tr>
								</table>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-3">
								<label>Criterio</label>
								<input type="text" th:id="'criterio'+ ${objeto.id} + '4'" th:value="${objeto.criterio4}" class="form-control" />
								<br>
								<textarea rows="3" style="width:100%" th:id="'descripcion' + ${objeto.id} + '4'" th:text="${objeto.descripcion4}" class="form-control">
								</textarea>
								<br>
								<table>
									<tr>
										<td>
											<label>Puntaje</label>
										</td>
										<td>
											<select th:id="'puntaje' + ${objeto.id} + '4'" class="form-control">
												<option value="0">Seleccione</option>
												<option th:each="len:${listapuntaje}" th:value="${len}" th:utext="${len}" th:selected="${len == objeto.puntaje4}"/>
											</select>
										</td>
									</tr>
								</table>
							</div>
						</div>
					</div>			
					<br>
		</div>
		<div th:each="objeto : ${listaquestionario}">
			<div class="row" style="background-color:#9E9E9E;padding:10px">
				<table style="width:100%">
					<tr>
						<td>
							<strong>Ingrese pregunta</strong>
							<input type="text" class="form-control" th:id="'pregunta'+ ${objeto.id}" th:value="${objeto.pregunta}"/>
						</td>
						<td>&nbsp;</td>
					</tr>
					<tr th:each="qr : ${objeto.questionariorespuesta}">
						<td>
							<label>Respuesta</label>
							<input type="text" class="form-control" th:id="'respuesta'+ ${qr.id}" th:value="${qr.respuesta}"/>
						</td>
						<td>
							<label>Puntaje</label>
							<select th:id="'puntajeq'+ ${qr.id}" class="form-control">
								<option value="0">Seleccione</option>
								<option th:each="len:${listapuntaje}" th:value="${len}" th:utext="${len}" th:selected="${len == qr.puntaje}"/>
							</select>
						</td>
					</tr>
				</table>						
			</div>
		</div>
		<br>
		<div class="row text-right">
			<div class="col-xs-6 col-sm-6">
				&nbsp;
			</div>
			<div class="col-xs-6 col-sm-6">
				<input type="button" name="btneditarevaluacion" id="btneditarevaluacion" value="Actualizar" class="btn btn-primary"/>
				<input type="button" name="btneditarhabilitarevaluacion" id="btneditarhabilitarevaluacion" value="Habilitar evaluación" class="btn btn-success"/>
				<input type="button" name="btncerrarevaluacionedit" id="btncerrarevaluacionedit" value="Cerrar" class="btn btn-danger"/>
			</div>
		</div>
		
	<div class="modal" tabindex="-1" role="dialog" id="modalimagencargando">
	  <center>
	  	<img th:src="@{./images/cargando.gif}" style="line-height: 200px;"/>
	  </center>	  
	</div>	
	
	<div class="modal" tabindex="-1" role="dialog" id="modalexitoeditevaluacion">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <img th:src="@{./images/imagen_exito5.png}"/>&nbsp;&nbsp; <strong class="pt-1">Registro exitoso</strong>
	      </div>
	      <div class="modal-body" id="textoexitoeditevaluacion">
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-primary rounded-0" id="btncerrarmensajeexitoeditevaluacion" name="btncerrarmensajeexitoeditevaluacion">Aceptar</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	
	<div class="modal" tabindex="-1" role="dialog" id="modalerroreditevaluacion">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <img th:src="@{./images/imagen_informacion11.png}"/>&nbsp;&nbsp; <strong class="pt-1">Error</strong>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>	          
	        </button>
	      </div>
	      <div class="modal-body" id="textoerroreditevaluacion">
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-danger rounded-0" id="btncerrarmensajeerroreditevaluacion" name="btncerrarmensajeerroreditevaluacion">Cerrar</button>
	      </div>
	    </div>
	  </div>
	</div>
	
	<div class="modal" tabindex="-1" role="dialog" id="modalinformacioneditevaluacion">
	  <div class="modal-dialog" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <img th:src="@{./images/imagen_informacion11.png}" />&nbsp;&nbsp; <label class="pt-1" style="padding-right:380px">Alerta</label>
	      </div>
	      <div class="modal-body" id="textoinformacioneditevaluacion">
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-danger rounded-0" id="btncerrarmensajeinformacioneditevaluacion" name="btncerrarmensajeinformacioneditevaluacion">Cerrar</button>
	      </div>
	    </div>
	  </div>
	</div>
	
</body>
</html>
<script type="text/javascript">
	
		var mensajeValidacionedit = "";
		var anioedit;
		var categoriaedit;
		var nivelparticipacionedit;
		var id_evaluacionedit;
		var array_rubricaedit , array_cuestionarioedit,array_respuesta_puntajeedit;
		var rubricaedit, criterio1edit, criterio2edit, criterio3edit, criterio4edit, criterio5edit, descripcion1edit, descripcion2edit, descripcion3edit, descripcion4edit, descripcion5edit,puntaje1edit, puntaje2edit, puntaje3edit, puntaje4edit, puntaje5edit;
		var preguntaidedit,preguntaedit, respuestaedit, puntajeedit,respuesta_puntaje_edit="";
		var id_rubricaedit , id_questionarioedit,id_pregunta_respuesta_edit;

		
		$("#btncerrarmensajeexitoeditevaluacion").click(function(){			
			$("#modalexitoeditevaluacion").modal('hide');
			$("#modaleditarEvaluacion").modal('hide');
		});
		
		$("#btncerrarmensajeerroreditevaluacion").click(function(){			
			$("#modalerroreditevaluacion").modal('hide');
		});
		
		$("#btncerrarmensajeinformacioneditevaluacion").click(function(){			
			$("#modalinformacioneditevaluacion").modal('hide');
		});	
		
		$("#btncerrarevaluacionedit").click(function(){
			$("#modaleditarEvaluacion").modal('hide');
		});	
		
$("#btneditarevaluacion").click(function(){	
			
			/*$("#modalimagencargando").modal({
				show : true,
				backdrop : 'static',
				keyboard:false
			});*/
			
			if(validarCamposedit()){
				
				id_evaluacionedit = $("#id_evaluacion").val();
				id_rubricaedit = $("#id_rubrica").val();
				id_questionarioedit = $("#id_questionario").val();
				
				array_rubricaedit = new Array();
				array_cuestionarioedit = new Array();
				array_respuesta_puntajeedit = new Array();
				
				id_rubricaedit = id_rubricaedit.split("-");
				
				for(var i=0;i<id_rubricaedit.length-1;i++){					
					rubrica = $("#rubrica"+id_rubrica[i]).val();
					criterio1edit = $("#criterio"+id_rubricaedit[i]+"1").val();
					criterio2edit = $("#criterio"+id_rubricaedit[i]+"2").val();
					criterio3edit = $("#criterio"+id_rubricaedit[i]+"3").val();
					criterio4edit = $("#criterio"+id_rubricaedit[i]+"4").val();
					criterio5edit = $("#criterio"+id_rubricaedit[i]+"5").val();
					descripcion1edit = $("#descripcion"+id_rubricaedit[i]+"1").val();
					descripcion2edit = $("#descripcion"+id_rubricaedit[i]+"2").val();
					descripcion3edit = $("#descripcion"+id_rubricaedit[i]+"3").val();
					descripcion4edit = $("#descripcion"+id_rubricaedit[i]+"4").val();
					descripcion5edit = $("#descripcion"+id_rubricaedit[i]+"5").val();
					puntaje1edit = $("#puntaje"+id_rubricaedit[i]+"1").val();
					puntaje2edit = $("#puntaje"+id_rubricaedit[i]+"2").val();
					puntaje3edit = $("#puntaje"+id_rubricaedit[i]+"3").val();
					puntaje4edit = $("#puntaje"+id_rubricaedit[i]+"4").val();
					puntaje5edit = $("#puntaje"+id_rubricaedit[i]+"5").val();
					
					array_rubricaedit.push({
						id : id_rubricaedit[i],
						rubrica : rubricaedit,
						criterio1 : criterio1edit,
						criterio2 : criterio2edit,
						criterio3 : criterio3edit,
						criterio4 : criterio4edit,
						criterio5 : criterio5edit,
						descripcion1 : descripcion1edit,
						descripcion2 : descripcion2edit,
						descripcion3 : descripcion3edit,
						descripcion4 : descripcion4edit,
						descripcion5 : descripcion5edit,
						puntaje1 : puntaje1edit,
						puntaje2 : puntaje2edit,
						puntaje3 : puntaje3edit,
						puntaje4 : puntaje4edit,
						puntaje5 : puntaje5edit
					});
				}				
				
				var j = 0;
				var x = 0;
				var bandera_j = true;
				var bandera_x = true;
				var array_id_pregunta_respuesta_edit= new Array();
				id_pregunta_respuesta_edit = $("#id_pregunta_respuesta").val();
				array_id_pregunta_respuesta_edit = id_pregunta_respuesta_edit.split('');
				console.log("id_pregunta_respuesta_edit :" + id_pregunta_respuesta_edit);
				for(var i=0;i<id_pregunta_respuesta_edit.length-1;i++){
					j = i+1;
					if(id_pregunta_respuesta_edit[i] == "("){
						bandera_j = true;
						while(bandera_j){
							if(array_id_pregunta_respuesta_edit[j] == "*"){
								console.log("i : " + i + " - " + array_id_pregunta_respuesta_edit[i]);
								console.log("j : " + j + " - " + array_id_pregunta_respuesta_edit[j]);
								preguntaidedit = id_pregunta_respuesta_edit.substring(i+1,j);
								console.log("preguntaidedit :" + preguntaidedit);
								preguntaedit = $("#pregunta"+preguntaidedit).val();								
								console.log("preguntaedit :" + preguntaedit);
								x = j+1;
								bandera_x = true;
								while(bandera_x){
									if(array_id_pregunta_respuesta_edit[x] == ")"){
										respuesta_puntaje_edit = id_pregunta_respuesta_edit.substring(j+1,x);
										respuesta_puntaje_edit = respuesta_puntaje_edit.split("-"); 
										console.log("respuesta_puntaje_edit :" + respuesta_puntaje_edit);
										for(var z = 0;z<respuesta_puntaje_edit.length;z++){
											respuestaedit = $("#respuesta"+respuesta_puntaje_edit[z]).val();
											puntajeedit = $("#puntajeq"+respuesta_puntaje_edit[z]).val();
											array_respuesta_puntajeedit.push({
												id : respuesta_puntaje_edit[z],
												respuesta : respuestaedit,
												puntaje : puntajeedit
											});
										}
										console.log('i : ' + i);
										console.log('j : ' + j);
										console.log('x : ' + x);
										console.log('z : ' + z);
										array_cuestionarioedit.push({
											id : preguntaidedit,
											pregunta : preguntaedit,
											questionariorespuesta : array_respuesta_puntajeedit
										});
										i=x;
										bandera_x = false;
									}
									x++;
								}
								bandera_j = false;      							
							j++;
						}
					}
				}
				}
				
				console.log("arraypuntahe :" + array_respuesta_puntajeedit);
				
				var evaluaciondtoedit = {
					evaluacion : {
						id: id_evaluacionedit,
						anio : anioedit,
						categoriaevaluacion : {
							id : categoriaedit
						},
						nivelparticipacion : {
							id : nivelparticipacionedit
						},
						estadoevaluacion : {
							id : 1
						},
						estado : 1
					},
					listarubrica: array_rubricaedit,
					listaquestionario : array_cuestionarioedit
				};
				console.log(evaluaciondtoedit);
				/*$.ajax({
					type : "POST",
				    contentType : "application/json",
				    url : url_base + "pedesa/actualizarevaluacion",
				    data : JSON.stringify(evaluaciondtoedit),
				    dataType : 'json',
					success: function(respuesta) {
						if(respuesta.id>0){
							
							$("#modalimagencargando").modal('hide');
							
							table_lista_evaluacion.cell(celdaseleccionada,1).data(anioedit).draw();
						    table_lista_evaluacion.cell(celdaseleccionada,2).data($("#nivelparticipacionce_edit option:selected").html()).draw();
						    table_lista_evaluacion.cell(celdaseleccionada,3).data($("#categoriace_edit option:selected").html()).draw();
						    table_lista_evaluacion.cell(celdaseleccionada,4).data("Editando").draw();
						    limpiarControlesedit();
							$("#textoexitoeditevaluacion").html("Se actualizó evaluación");
							$('#modalexitoeditevaluacion').modal({
								show : true,
								backdrop : 'static',
								keyboard:false
							});
							
							
						}
						else{
							$("#modalimagencargando").modal('hide');
							$("#textoerroreditevaluacion").html("Error al actualizar evaluación");
							$('#modalerroreditevaluacion').modal({
								show : true,
								backdrop : 'static',
								keyboard:false
							});
						}
					},
					error: function() {
						$("#modalimagencargando").modal('hide');
						$("#textoerroreditevaluacion").html("Excepción al actualizar evaluación");
						$('#modalerroreditevaluacion').modal({
							show : true,
							backdrop : 'static',
							keyboard:false
						});
				    }
				});*/
			}
			/*else{
				$("#modalimagencargando").modal('hide');
				$("#textoinformacioneditevaluacion").html("<div style='color:red' class='text-left'>"+mensajeValidacion+"</div>");
				$('#modalinformacioneditrevaluacion').modal({
					show : true,
					backdrop : 'static',
					keyboard:false
				});
			}*/
		});
		
		function limpiarControlesedit(){
			$("#anioce_edit").val("");
			$("#categoriace_edit").val("");
			$("#nivelparticipacionce_edit").val("");
		}
		
		function validarCamposedit(){
			
			/*arrayParticipante = new Array()*/
			
			mensajeValidacionedit = "";
			anioedit = $("#anioce_edit").val();
			categoriaedit = $("#categoriace_edit").val();
			nivelparticipacionedit = $("#nivelparticipacionce_edit").val();
			
			if(anioedit == ""){
				mensajeValidacionedit += "Debe seleccionar Año"+"<br>";
			}
			
			if(categoriaedit==""){
				mensajeValidacionedit += "Debe seleccionar Categoria"+"<br>";
			}
			
			if(nivelparticipacionedit==""){
				mensajeValidacionedit += "Debe seleccionar Nivel de participación"+"<br>";
			}
			if(mensajeValidacionedit!=""){
				return false;
			}
			return true;
		}
		
</script>